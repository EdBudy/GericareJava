<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security" xmlns:class="http://www.w3.org/1999/xhtml" lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <!-- Incluimos la cabecera del layout que tiene los estilos -->
    <th:block th:insert="~{fragments/layout :: head}"></th:block>
</head>
<body>

<!-- Incluimos el header reutilizable -->
<header th:insert="~{fragments/layout :: header}"></header>

<main class="container mt-5">

    <!-- Sección para el Administrador -->
    <!-- Este bloque solo se renderizará si el usuario tiene el rol 'Administrador' -->
    <div sec:authorize="hasRole('Administrador')">
        <!--
          SOLUCIÓN CLAVE:
          Usamos th:replace en lugar de th:insert para reemplazar este div con el contenido del fragmento.
          Lo más importante es que pasamos la variable 'usuarios' que viene del controlador
          directamente al fragmento. Ahora el fragmento 'tabla-usuarios' recibe los datos que necesita para funcionar.
        -->
        <div th:replace="~{fragments/tabla-usuarios :: tabla(usuarios=${usuarios})}"></div>
    </div>

    <!-- Sección para el Cuidador -->
    <!-- Este bloque solo se renderizará si el usuario tiene el rol 'Cuidador' -->
    <div sec:authorize="hasRole('Cuidador')">
        <h2>Mis Pacientes Asignados</h2>
        <div th:if="${pacientesAsignados.isEmpty()}">
            <div class="alert alert-info">Aún no tienes pacientes asignados.</div>
        </div>
        <div class:if="${!pacientesAsignados.isEmpty()}" class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                        <tr>
                            <th>ID Paciente</th>
                            <th>Nombre Paciente</th>
                            <th>Documento</th>
                            <th>Familiar Asignado</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="asignacion : ${pacientesAsignados}">
                            <td th:text="${asignacion.paciente.idPaciente}"></td>
                            <td th:text="${asignacion.paciente.nombre + ' ' + asignacion.paciente.apellido}"></td>
                            <td th:text="${asignacion.paciente.documentoIdentificacion}"></td>
                            <td th:text="${asignacion.familiar != null ? asignacion.familiar.nombre + ' ' + asignacion.familiar.apellido : 'N/A'}"></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Sección para el Familiar -->
    <!-- Este bloque solo se renderizará si el usuario tiene el rol 'Familiar' -->
    <div sec:authorize="hasRole('Familiar')">
        <h2>Información del Paciente Asignado</h2>
        <div th:if="${pacienteAsignado.isPresent()}">
            <div class="patient-card">
                <h3 th:text="${pacienteAsignado.get().paciente.nombre + ' ' + pacienteAsignado.get().paciente.apellido}"></h3>
                <hr>
                <p><strong>Documento:</strong> <span th:text="${pacienteAsignado.get().paciente.documentoIdentificacion}"></span></p>
                <p><strong>Cuidador Asignado:</strong> <span th:text="${pacienteAsignado.get().cuidador.nombre + ' ' + pacienteAsignado.get().cuidador.apellido}"></span></p>
                <p><strong>Fecha de Asignación:</strong> <span th:text="${#temporals.format(pacienteAsignado.get().fechaCreacion, 'dd/MM/yyyy HH:mm')}"></span></p>
            </div>
        </div>
        <div th:if="${pacienteAsignado.isEmpty()}">
            <div class="alert alert-warning">Usted aún no ha sido asignado a ningún paciente.</div>
        </div>
    </div>

</main>

<!-- Incluimos el footer reutilizable -->
<footer th:insert="~{fragments/layout :: footer}"></footer>
</body>
</html>

