<!DOCTYPE html>
<!--
  Este es el archivo principal del Dashboard.
  Utiliza Thymeleaf y Spring Security para mostrar contenido dinámico
  basado en el rol del usuario autenticado.
-->
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Gericare</title>
    <!--
      Se inserta el fragmento 'head' desde layout.html.
      Esto nos trae todos los enlaces a CSS (Bootstrap y styles.css) y el viewport.
    -->
    <th:block th:insert="~{fragments/layout :: head}"></th:block>
</head>
<body>

<!--
  Se inserta la barra de navegación (header) desde layout.html.
  Esto mantiene la cabecera consistente en toda la aplicación.
-->
<header th:insert="~{fragments/layout :: header}"></header>

<!-- Contenido principal de la página -->
<main class="container mt-5">

    <!-- Banner de bienvenida que se muestra a todos los usuarios logueados -->
    <div class="p-5 mb-4 bg-light rounded-3">
        <div class="container-fluid py-5">
            <h1 class="display-5 fw-bold">Bienvenido a Gericare</h1>
            <p class="col-md-8 fs-4">
                Has iniciado sesión como <strong sec:authentication="name">Usuario</strong>.
                Tu rol es:
                <!-- Se muestra una insignia de color diferente según el rol del usuario -->
                <span sec:authorize="hasRole('ADMINISTRADOR')" class="badge bg-danger">Administrador</span>
                <span sec:authorize="hasRole('CUIDADOR')" class="badge bg-info">Cuidador</span>
                <span sec:authorize="hasRole('FAMILIAR')" class="badge bg-success">Familiar</span>
            </p>
        </div>
    </div>

    <!-- ====================================================== -->
    <!-- Sección del Dashboard para el Administrador -->
    <!-- Visible únicamente si el usuario tiene el rol 'ADMINISTRADOR' -->
    <!-- ====================================================== -->
    <div sec:authorize="hasRole('ADMINISTRADOR')">
        <h2>Gestión de Usuarios</h2>
        <p>Desde aquí puedes ver, filtrar y gestionar todos los usuarios del sistema.</p>
        <!--
          Se reemplaza este div con el contenido del fragmento 'tabla_usuarios'
          que se encuentra en 'fragments/tabla-usuarios.html'.
          Se le pasan todos los datos necesarios que el controlador ha puesto en el modelo.
        -->
        <div th:replace="~{fragments/tabla-usuarios :: tabla_usuarios(usuarios=${usuarios}, roles=${roles}, nombreFiltro=${nombre}, documentoFiltro=${documento}, rolFiltro=${rol})}">
            <!-- El contenido de la tabla de usuarios se insertará aquí -->
        </div>
    </div>

    <!-- ====================================================== -->
    <!-- Sección del Dashboard para el Cuidador -->
    <!-- Visible únicamente si el usuario tiene el rol 'CUIDADOR' -->
    <!-- ====================================================== -->
    <div sec:authorize="hasRole('CUIDADOR')">
        <h2>Mis Pacientes Asignados</h2>
        <p>Esta es la lista de los pacientes que tienes actualmente a tu cargo.</p>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                <tr>
                    <th>Paciente</th>
                    <th>Documento</th>
                    <th>Contacto de Emergencia</th>
                    <th>Familiar Asociado</th>
                </tr>
                </thead>
                <tbody>
                <!-- Se itera sobre la lista de pacientes asignados y se muestra cada uno en una fila -->
                <tr th:each="asignacion : ${pacientesAsignados}">
                    <td th:text="${asignacion.paciente.nombre + ' ' + asignacion.paciente.apellido}"></td>
                    <td th:text="${asignacion.paciente.documentoIdentificacion}"></td>
                    <td th:text="${asignacion.paciente.contactoEmergencia}"></td>
                    <!-- Se comprueba si el familiar es nulo antes de mostrar su nombre -->
                    <td th:text="${asignacion.familiar != null ? asignacion.familiar.nombre + ' ' + asignacion.familiar.apellido : 'No asignado'}"></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- ====================================================== -->
    <!-- Sección del Dashboard para el Familiar -->
    <!-- Visible únicamente si el usuario tiene el rol 'FAMILIAR' -->
    <!-- ====================================================== -->
    <div sec:authorize="hasRole('FAMILIAR')">
        <h2>Información de mi Familiar</h2>
        <!-- Se muestra esta tarjeta solo si el familiar tiene un paciente asignado -->
        <div th:if="${pacienteAsignado != null}" class="card">
            <div class="card-header fs-5 fw-bold" th:text="${pacienteAsignado.paciente.nombre + ' ' + pacienteAsignado.paciente.apellido}">
                Nombre del Paciente
            </div>
            <ul class="list-group list-group-flush">
                <li class="list-group-item"><b>Cuidador Asignado:</b> <span th:text="${pacienteAsignado.cuidador.nombre + ' ' + pacienteAsignado.cuidador.apellido}"></span></li>
                <li class="list-group-item"><b>Contacto de Emergencia:</b> <span th:text="${pacienteAsignado.paciente.contactoEmergencia}"></span></li>
                <li class="list-group-item"><b>Seguro Médico:</b> <span th:text="${pacienteAsignado.paciente.seguroMedico}"></span></li>
                <li class="list-group-item"><b>Número de Seguro:</b> <span th:text="${pacienteAsignado.paciente.numeroSeguro}"></span></li>
            </ul>
        </div>
        <!-- Se muestra esta alerta si el familiar NO tiene un paciente asignado -->
        <div th:if="${pacienteAsignado == null}" class="alert alert-warning">
            Aún no tienes un familiar asignado en el sistema.
        </div>
    </div>

</main>

<!--
  Se inserta el pie de página (footer) desde layout.html.
  Esto también nos trae los scripts de JavaScript de Bootstrap.
-->
<footer th:insert="~{fragments/layout :: footer}"></footer>

</body>
</html>

