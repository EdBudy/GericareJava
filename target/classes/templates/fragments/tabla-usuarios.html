<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<body>

<!--
  Fragmento reutilizable para mostrar la tabla de usuarios.
  Recibe dos parámetros:
  - usuarios: La lista de usuarios a mostrar.
  - roles: La lista de roles para el filtro desplegable.
-->
<div th:fragment="tabla_usuarios(usuarios, roles, nombreFiltro, documentoFiltro, rolFiltro)">

    <!-- Formulario de Filtros -->
    <form th:action="@{/dashboard}" method="get" class="filter-form mb-4">
        <div class="row g-3 align-items-end">
            <div class="col-md-4">
                <label for="nombre" class="form-label">Filtrar por Nombre</label>
                <!-- CORRECCIÓN: Se usa name y th:value en lugar de th:field -->
                <input type="text" id="nombre" name="nombre" th:value="${nombreFiltro}" class="form-control" placeholder="Ej: Juan">
            </div>
            <div class="col-md-3">
                <label for="documento" class="form-label">Filtrar por Documento</label>
                <!-- CORRECCIÓN: Se usa name y th:value en lugar de th:field -->
                <input type="text" id="documento" name="documento" th:value="${documentoFiltro}" class="form-control" placeholder="Ej: 123456">
            </div>
            <div class="col-md-3">
                <label for="rol" class="form-label">Filtrar por Rol</label>
                <!-- CORRECCIÓN: Se usa name y th:value/th:selected en lugar de th:field -->
                <select id="rol" name="rol" class="form-select">
                    <option value="">Todos</option>
                    <option th:each="rolOpt : ${roles}"
                            th:value="${rolOpt}"
                            th:text="${rolOpt.name()}"
                            th:selected="${rolOpt == rolFiltro}"></option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">Filtrar</button>
            </div>
        </div>
    </form>

    <!-- Tabla de Resultados -->
    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Nombre Completo</th>
                <th>Documento</th>
                <th>Email</th>
                <th>Rol</th>
                <!-- Solo el admin ve las acciones -->
                <th th:if="${#authorization.expression('hasRole(''ADMINISTRADOR'')')}">Acciones</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="usuario : ${usuarios}">
                <td th:text="${usuario.idUsuario}">1</td>
                <td th:text="${usuario.nombre + ' ' + usuario.apellido}">Nombre Apellido</td>
                <td th:text="${usuario.tipoDocumento + ' - ' + usuario.documentoIdentificacion}">CC - 12345</td>
                <td th:text="${usuario.correoElectronico}">correo@ejemplo.com</td>
                <td>
                    <span th:if="${#strings.contains(usuario.getClass().simpleName, 'Administrador')}" class="badge bg-danger">Administrador</span>
                    <span th:if="${#strings.contains(usuario.getClass().simpleName, 'Cuidador')}" class="badge bg-info">Cuidador</span>
                    <span th:if="${#strings.contains(usuario.getClass().simpleName, 'Familiar')}" class="badge bg-success">Familiar</span>
                </td>
                <!-- Botones de acción solo para el rol de Administrador -->
                <td th:if="${#authorization.expression('hasRole(''ADMINISTRADOR'')')}">
                    <a href="#" class="btn btn-sm btn-warning me-2">Editar</a>
                    <form th:action="@{/usuarios/{id}(id=${usuario.idUsuario})}" th:method="delete" style="display:inline;">
                        <button type="submit" class="btn btn-sm btn-danger">Eliminar</button>
                    </form>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

</div>

</body>
</html>

